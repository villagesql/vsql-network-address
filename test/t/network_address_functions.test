# Setup: Copy VEB to veb_dir if VSQL_NETWORK_ADDRESS_VEB is set, then install extension
--let $veb_dest = `SELECT CONCAT(@@veb_dir, '/vsql_network_address.veb')`
if ($VSQL_NETWORK_ADDRESS_VEB) {
  --error 0,1
  --remove_file $veb_dest
  --copy_file $VSQL_NETWORK_ADDRESS_VEB $veb_dest
}
INSTALL EXTENSION vsql_network_address;

########################################################################
#
# Test: network_address_functions
# Purpose: Comprehensive testing of network address utility functions
# User Type: Database User (using network address manipulation functions)
#
########################################################################

--replace_result $MYSQLTEST_VARDIR MYSQLTEST_VARDIR
--replace_result $MYSQL_TEST_DIR MYSQL_TEST_DIR

--disable_warnings
DROP TABLE IF EXISTS test_functions;
--enable_warnings

########################################################################
# Setup test table
########################################################################

CREATE TABLE test_functions (
    id INT PRIMARY KEY,
    inet_addr INET,
    cidr_addr CIDR,
    mac_addr MACADDR,
    description VARCHAR(100)
);

# Insert test data - IPv4
INSERT INTO test_functions (id, inet_addr, cidr_addr, mac_addr, description) VALUES
(1, vsql_network_address.inet_from_string('192.168.1.5/24'), vsql_network_address.cidr_from_string('192.168.1.0/24'), vsql_network_address.macaddr_from_string('08:00:2b:01:02:03'), 'Class C network'),
(2, vsql_network_address.inet_from_string('10.0.0.1/8'), vsql_network_address.cidr_from_string('10.0.0.0/8'), vsql_network_address.macaddr_from_string('12:34:56:78:9a:bc'), 'Class A network'),
(3, vsql_network_address.inet_from_string('172.16.1.100/16'), vsql_network_address.cidr_from_string('172.16.0.0/16'), vsql_network_address.macaddr_from_string('aa:bb:cc:dd:ee:ff'), 'Class B network'),
(4, vsql_network_address.inet_from_string('192.168.23.20/30'), vsql_network_address.cidr_from_string('192.168.23.20/30'), vsql_network_address.macaddr_from_string('00:00:00:00:00:00'), 'Small subnet'),
(5, vsql_network_address.inet_from_string('203.0.113.50/32'), vsql_network_address.cidr_from_string('203.0.113.50/32'), vsql_network_address.macaddr_from_string('ff:ff:ff:ff:ff:ff'), 'Single host');

# Insert test data - IPv6
INSERT INTO test_functions (id, inet_addr, cidr_addr, mac_addr, description) VALUES
(6, vsql_network_address.inet_from_string('2001:db8::1/64'), vsql_network_address.cidr_from_string('2001:db8::/64'), vsql_network_address.macaddr_from_string('08:00:2b:01:02:03'), 'IPv6 /64 network'),
(7, vsql_network_address.inet_from_string('fe80::1/10'), vsql_network_address.cidr_from_string('fe80::/10'), vsql_network_address.macaddr_from_string('12:34:56:78:9a:bc'), 'IPv6 link-local'),
(8, vsql_network_address.inet_from_string('2001:db8:85a3::8a2e:370:7334/48'), vsql_network_address.cidr_from_string('2001:db8:85a3::/48'), vsql_network_address.macaddr_from_string('aa:bb:cc:dd:ee:ff'), 'IPv6 /48 network'),
(9, vsql_network_address.inet_from_string('::1/128'), vsql_network_address.cidr_from_string('::1/128'), vsql_network_address.macaddr_from_string('00:00:00:00:00:00'), 'IPv6 loopback');

########################################################################
#
# Test 1: Simple Extractors
#
########################################################################

--echo # Test inet_family - extract address family
SELECT id, description, vsql_network_address.inet_family(inet_addr) AS family
FROM test_functions ORDER BY id;

--echo # Test inet_masklen - extract netmask length
SELECT id, description, vsql_network_address.inet_masklen(inet_addr) AS masklen
FROM test_functions ORDER BY id;

--echo # Test inet_host - extract IP address without netmask
SELECT id, description, vsql_network_address.inet_host(inet_addr) AS host
FROM test_functions ORDER BY id;

--echo # Test inet_text - extract IP address with netmask
SELECT id, description, vsql_network_address.inet_text(inet_addr) AS text
FROM test_functions ORDER BY id;

########################################################################
#
# Test 2: Mask Calculations
#
########################################################################

--echo # Test inet_netmask - construct netmask for network
SELECT id, description,
       vsql_network_address.inet_text(inet_addr) AS address,
       vsql_network_address.inet_to_string(vsql_network_address.inet_netmask(inet_addr)) AS netmask
FROM test_functions ORDER BY id;

--echo # Test inet_hostmask - construct host mask (inverse of netmask)
SELECT id, description,
       vsql_network_address.inet_text(inet_addr) AS address,
       vsql_network_address.inet_to_string(vsql_network_address.inet_hostmask(inet_addr)) AS hostmask
FROM test_functions ORDER BY id;

--echo # Test inet_broadcast - calculate broadcast address
SELECT id, description,
       vsql_network_address.inet_text(inet_addr) AS address,
       vsql_network_address.inet_to_string(vsql_network_address.inet_broadcast(inet_addr)) AS broadcast
FROM test_functions ORDER BY id;

--echo # Test inet_network - extract network address
SELECT id, description,
       vsql_network_address.inet_text(inet_addr) AS address,
       vsql_network_address.cidr_to_string(vsql_network_address.inet_network(inet_addr)) AS network
FROM test_functions ORDER BY id;


########################################################################
#
# Test 3: Formatting (Abbreviation)
#
########################################################################

--echo # Test inet_abbrev - omit /32 for single hosts
SELECT id, description,
       vsql_network_address.inet_text(inet_addr) AS full_format,
       vsql_network_address.inet_abbrev(inet_addr) AS abbreviated
FROM test_functions ORDER BY id;

--echo # Test cidr_abbrev - show minimal significant octets
SELECT id, description,
       vsql_network_address.cidr_to_string(cidr_addr) AS full_format,
       vsql_network_address.cidr_abbrev(cidr_addr) AS abbreviated
FROM test_functions ORDER BY id;

########################################################################
#
# Test 4: Combined Function Usage
#
########################################################################

--echo # Test all functions together on sample data
SELECT
       vsql_network_address.inet_family(vsql_network_address.inet_from_string('192.168.1.5/24')) AS family,
       vsql_network_address.inet_masklen(vsql_network_address.inet_from_string('192.168.1.5/24')) AS masklen,
       vsql_network_address.inet_host(vsql_network_address.inet_from_string('192.168.1.5/24')) AS host,
       vsql_network_address.inet_text(vsql_network_address.inet_from_string('192.168.1.5/24')) AS text,
       vsql_network_address.inet_to_string(vsql_network_address.inet_netmask(vsql_network_address.inet_from_string('192.168.1.5/24'))) AS netmask,
       vsql_network_address.inet_to_string(vsql_network_address.inet_hostmask(vsql_network_address.inet_from_string('192.168.1.5/24'))) AS hostmask,
       vsql_network_address.inet_to_string(vsql_network_address.inet_broadcast(vsql_network_address.inet_from_string('192.168.1.5/24'))) AS broadcast,
       vsql_network_address.cidr_to_string(vsql_network_address.inet_network(vsql_network_address.inet_from_string('192.168.1.5/24'))) AS network;

########################################################################
#
# Test 5: Edge Cases
#
########################################################################

--echo # Test edge cases - /0 and /32
SELECT
    vsql_network_address.inet_to_string(vsql_network_address.inet_set_masklen(vsql_network_address.inet_from_string('192.168.1.5/24'), 0)) AS masklen_0,
    vsql_network_address.inet_to_string(vsql_network_address.inet_set_masklen(vsql_network_address.inet_from_string('192.168.1.5/24'), 32)) AS masklen_32;

--echo # Test abbreviation edge cases
SELECT
    vsql_network_address.cidr_abbrev(vsql_network_address.cidr_from_string('0.0.0.0/0')) AS slash_0,
    vsql_network_address.cidr_abbrev(vsql_network_address.cidr_from_string('10.0.0.0/8')) AS slash_8,
    vsql_network_address.cidr_abbrev(vsql_network_address.cidr_from_string('192.168.0.0/16')) AS slash_16;

########################################################################
#
# Test 6: Comparison helpers
#
########################################################################

--echo # inet_compare returns ordering semantics (-1, 0, 1)
SELECT
    vsql_network_address.inet_compare(vsql_network_address.inet_from_string('10.0.0.1'), vsql_network_address.inet_from_string('10.0.0.2')) AS inet_lt,
    vsql_network_address.inet_compare(vsql_network_address.inet_from_string('10.0.0.1'), vsql_network_address.inet_from_string('10.0.0.1')) AS inet_eq,
    vsql_network_address.inet_compare(vsql_network_address.inet_from_string('10.0.0.2'), vsql_network_address.inet_from_string('10.0.0.1')) AS inet_gt;

--echo # cidr_compare matches INET ordering rules
SELECT
    vsql_network_address.cidr_compare(vsql_network_address.cidr_from_string('10.0.0.0/8'), vsql_network_address.cidr_from_string('10.0.0.0/16')) AS cidr_lt,
    vsql_network_address.cidr_compare(vsql_network_address.cidr_from_string('10.0.0.0/8'), vsql_network_address.cidr_from_string('10.0.0.0/8')) AS cidr_eq,
    vsql_network_address.cidr_compare(vsql_network_address.cidr_from_string('10.0.0.0/16'), vsql_network_address.cidr_from_string('10.0.0.0/8')) AS cidr_gt;

--echo # macaddr_compare sorts lexicographically by bytes
SELECT
    vsql_network_address.macaddr_compare(vsql_network_address.macaddr_from_string('00:00:00:00:00:00'), vsql_network_address.macaddr_from_string('00:00:00:00:00:01')) AS mac_lt,
    vsql_network_address.macaddr_compare(vsql_network_address.macaddr_from_string('00:00:00:00:00:01'), vsql_network_address.macaddr_from_string('00:00:00:00:00:01')) AS mac_eq,
    vsql_network_address.macaddr_compare(vsql_network_address.macaddr_from_string('ff:ff:ff:ff:ff:ff'), vsql_network_address.macaddr_from_string('00:00:00:00:00:01')) AS mac_gt;

--echo # macaddr8_compare mirrors macaddr behavior for 8-byte addresses
SELECT
    vsql_network_address.macaddr8_compare(vsql_network_address.macaddr8_from_string('00:00:00:00:00:00:00:00'), vsql_network_address.macaddr8_from_string('00:00:00:00:00:00:00:01')) AS mac8_lt,
    vsql_network_address.macaddr8_compare(vsql_network_address.macaddr8_from_string('00:00:00:00:00:00:00:01'), vsql_network_address.macaddr8_from_string('00:00:00:00:00:00:00:01')) AS mac8_eq,
    vsql_network_address.macaddr8_compare(vsql_network_address.macaddr8_from_string('ff:ff:ff:ff:ff:ff:ff:ff'), vsql_network_address.macaddr8_from_string('00:00:00:00:00:00:00:01')) AS mac8_gt;

########################################################################
# Cleanup
########################################################################

DROP TABLE test_functions;

# Remove extension from registry
UNINSTALL EXTENSION vsql_network_address;
